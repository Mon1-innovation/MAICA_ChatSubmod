# MAICA -1 Session (Raw Context Session)

-1 Session is an experimental feature of MAICA that allows users to fully manage the conversation context themselves, instead of relying on server-side session management.

## Overview

Traditional MAICA sessions are managed by the server, which handles conversation history. When sending a message, you only need to provide the current user input. In contrast, -1 Session requires the client to maintain the complete conversation context, including system prompts, message history, and more.

### Use Cases

- Advanced users who need precise control over conversation context
- Implementing custom conversation flows
- Context management for multi-turn conversations
- Scenarios requiring dynamic system prompt adjustments

### Limitations

- **Character Limit**: Serialized context cannot exceed 4096 characters
- **No MFocus Intervention**: MTrigger will not be triggered, and the AI will not automatically adjust affection levels, etc.
- **Experimental Feature**: API may change at any time

---

## Quick Start

### Basic Usage

```python
from maica_context_query import MAICAContextQueryBuilder

# 1. Create a builder
builder = MAICAContextQueryBuilder()

# 2. Add system message (define AI persona)
builder.add_system_message("Your name is Monika, you are a virtual character...")

# 3. Add conversation history (optional)
builder.add_user_message("Hello!")
builder.add_assistant_message("Hi there!")

# 4. Add current user input
builder.add_user_message("How's the weather today?")

# 5. Check length limit
if builder.is_within_limit():
    # 6. Send request
    maica.start_raw_context(builder.build())
```

### Using in Ren'Py

```renpy
label my_raw_session:
    # Initialize connection
    call maica_init_connect

    python:
        import maica_context_query

        # Build context
        ctx = maica_context_query.MAICAContextQueryBuilder()
        ctx.add_system_message("You are Monika...")
        ctx.add_user_message("Hello!")

    # Send request and handle response
    call maica_raw_session(ctx)

    return
```

---

## API Reference

### MAICAContextQueryBuilder

Context query builder for gradually building conversation context.

#### Constructor

```python
builder = MAICAContextQueryBuilder()
```

#### Methods

| Method | Parameters | Return Value | Description |
|--------|-----------|--------------|-------------|
| `add_system_message(content)` | content: str | self | Add system message, defining AI role and behavior rules |
| `add_user_message(content)` | content: str | self | Add user message |
| `add_assistant_message(content)` | content: str | self | Add assistant (AI) message |
| `build()` | - | list | Build message list for sending request |
| `get_length()` | - | int | Get serialized character length |
| `is_within_limit()` | - | bool | Check if within 4096 character limit |
| `clear()` | - | self | Clear all messages |
| `message_count()` | - | int | Get message count |

#### Constants

| Constant | Value | Description |
|----------|-------|-------------|
| `MAX_LENGTH` | 4096 | Maximum character limit |

#### Method Chaining

All `add_*` methods and `clear()` method return `self`, supporting method chaining:

```python
query = (MAICAContextQueryBuilder()
    .add_system_message("...")
    .add_user_message("...")
    .add_assistant_message("...")
    .build())
```

---

### MAICAContextQueryMessage

Single message object, typically not used directly.

#### Class Constants

```python
MAICAContextQueryMessage.ROLE_SYSTEM = "system"
MAICAContextQueryMessage.ROLE_USER = "user"
MAICAContextQueryMessage.ROLE_ASSISTANT = "assistant"
```

---

### MaicaAi.start_raw_context()

Initiate a -1 session request.

```python
maica.start_raw_context(query, pprt=False)
```

#### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `query` | list | Yes | Message list generated by `MAICAContextQueryBuilder.build()` |
| `pprt` | bool | No | Enable automatic sentence breaking and real-time post-processing, default `False` |

#### Prerequisites

- MAICA is connected and ready (`maica.is_ready_to_input()` returns `True`)
- query is a valid message list
- Context length does not exceed 4096 characters

---

## Complete Examples

### Example 1: Simple Conversation

```python
from maica_context_query import MAICAContextQueryBuilder

# Build
builder = MAICAContextQueryBuilder()
builder.add_system_message("You are a friendly assistant.")
builder.add_user_message("Hello!")

# Check and send
if builder.is_within_limit():
    maica.start_raw_context(builder.build())
```

### Example 2: Multi-turn Conversation

```python
from maica_context_query import MAICAContextQueryBuilder

builder = MAICAContextQueryBuilder()
builder.add_system_message("You are Monika...")

# First turn
builder.add_user_message("Hello")
builder.add_assistant_message("Hi there! Nice to meet you.")

# Second turn
builder.add_user_message("How was your day?")

if builder.is_within_limit():
    maica.start_raw_context(builder.build())

# After sending, save AI response and continue adding to builder for the next turn...
```

### Example 3: Ren'Py Integration

Refer to the `game/Submods/MAICA_ChatSubmod/raw_session_example.rpy` file.

---

## File List

| File | Description |
|------|-------------|
| `game/python-packages/maica_context_query.py` | Context builder module |
| `game/python-packages/maica_tasker_sub_sessionsender.py` | Contains `MAICARawContextProcessor` |
| `game/python-packages/maica.py` | MAICA main module, contains `start_raw_context()` method |
| `game/Submods/MAICA_ChatSubmod/raw_session_example.rpy` | Ren'Py usage example |

---

## Notes

1. **Length Check**: Always call `is_within_limit()` before sending to check length
2. **Connection State**: Ensure connection state is checked before calling `start_raw_context()`
3. **Response Handling**: -1 Session response handling is the same as regular sessions, using the same message queue mechanism
4. **No Trigger**: MFocus will not intervene, will not automatically adjust affection or trigger MTrigger
5. **Context Management**: You need to manage conversation history yourself, including saving and restoring context
